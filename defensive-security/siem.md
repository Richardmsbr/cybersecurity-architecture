# SIEM Architecture & Implementation

## Overview

Security Information and Event Management (SIEM) provides real-time analysis of security alerts generated by network hardware and applications. This document covers architecture, implementation, and operational best practices.

---

## SIEM Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SIEM ARCHITECTURE                                   │
│                                                                             │
│  DATA SOURCES                        COLLECTION                             │
│  ────────────                        ──────────                             │
│                                                                             │
│  ┌─────────────┐                    ┌─────────────┐                         │
│  │  Endpoints  │──────┐             │             │                         │
│  │  (EDR)      │      │             │   Syslog    │                         │
│  └─────────────┘      │             │   Server    │                         │
│                       │             │  (514/UDP)  │                         │
│  ┌─────────────┐      │             └──────┬──────┘                         │
│  │  Network    │──────┤                    │                                │
│  │  (Firewall) │      │             ┌──────▼──────┐                         │
│  └─────────────┘      ├────────────>│   Message   │                         │
│                       │             │    Queue    │                         │
│  ┌─────────────┐      │             │  (Kafka)    │                         │
│  │  Servers    │──────┤             └──────┬──────┘                         │
│  │  (Windows)  │      │                    │                                │
│  └─────────────┘      │             ┌──────▼──────┐                         │
│                       │             │   Log       │                         │
│  ┌─────────────┐      │             │  Parser     │                         │
│  │  Cloud      │──────┤             │ (Logstash)  │                         │
│  │  (AWS/Azure)│      │             └──────┬──────┘                         │
│  └─────────────┘      │                    │                                │
│                       │                    │                                │
│  ┌─────────────┐      │                    │                                │
│  │ Applications│──────┘                    │                                │
│  │ (Web/API)   │                           │                                │
│  └─────────────┘                           │                                │
│                                            │                                │
│  PROCESSING                    STORAGE            ANALYSIS                  │
│  ──────────                    ───────            ────────                  │
│                                                                             │
│  ┌─────────────┐         ┌─────────────┐    ┌─────────────┐                │
│  │ Enrichment  │         │             │    │  Detection  │                │
│  │             │         │   Index     │    │   Engine    │                │
│  │ • GeoIP     │◄───────>│  (Elastic-  │───>│             │                │
│  │ • Threat    │         │   search)   │    │ • Rules     │                │
│  │   Intel     │         │             │    │ • ML/UEBA   │                │
│  │ • Asset DB  │         │  Hot: 7d    │    │ • Threat    │                │
│  │             │         │  Warm: 30d  │    │   Intel     │                │
│  └─────────────┘         │  Cold: 1yr  │    └──────┬──────┘                │
│                          └─────────────┘           │                        │
│                                                    │                        │
│  RESPONSE                                          │                        │
│  ────────                                          │                        │
│                                                    │                        │
│  ┌─────────────┐    ┌─────────────┐    ┌─────────▼─────┐                   │
│  │   Alert     │◄───│    SOAR     │◄───│   Dashboard   │                   │
│  │  Management │    │ (Playbooks) │    │   (Kibana)    │                   │
│  └─────────────┘    └─────────────┘    └───────────────┘                   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Log Source Priority Matrix

| Source | Priority | EPS Estimate | Retention |
|--------|----------|--------------|-----------|
| Domain Controllers | Critical | 500-2000 | 1 year |
| Firewalls | Critical | 1000-10000 | 90 days |
| VPN Concentrators | Critical | 100-500 | 90 days |
| EDR | Critical | 500-5000 | 1 year |
| Web Proxies | High | 1000-5000 | 90 days |
| DNS Servers | High | 5000-50000 | 30 days |
| Email Gateways | High | 100-1000 | 90 days |
| Web Servers | High | 500-5000 | 90 days |
| Databases | Medium | 100-1000 | 90 days |
| Workstations | Medium | 100-500 each | 30 days |
| Cloud (AWS/Azure) | High | 1000-10000 | 90 days |

---

## Critical Windows Event IDs

### Authentication Events

| Event ID | Description | Severity | Detection Use Case |
|----------|-------------|----------|-------------------|
| 4624 | Successful logon | Info | Baseline, lateral movement |
| 4625 | Failed logon | Medium | Brute force, password spray |
| 4648 | Explicit credential logon | High | Pass-the-hash, credential use |
| 4768 | Kerberos TGT request | Info | Authentication tracking |
| 4769 | Kerberos service ticket | Info | Kerberoasting detection |
| 4771 | Kerberos pre-auth failed | Medium | Password attacks |
| 4776 | NTLM authentication | Medium | NTLM relay attacks |

### Privilege Escalation

| Event ID | Description | Severity | Detection Use Case |
|----------|-------------|----------|-------------------|
| 4672 | Special privileges assigned | High | Admin logon tracking |
| 4673 | Privileged service called | Medium | Privilege abuse |
| 4674 | Privileged operation | Medium | Sensitive operations |
| 4688 | Process creation | Info | Command execution |
| 4697 | Service installed | High | Persistence |
| 4698 | Scheduled task created | High | Persistence |

### Object Access

| Event ID | Description | Severity | Detection Use Case |
|----------|-------------|----------|-------------------|
| 4663 | Object access attempt | Info | File access monitoring |
| 4656 | Handle to object | Info | Access attempts |
| 4660 | Object deleted | Medium | Data destruction |
| 4670 | Permissions changed | High | Access control changes |

### Account Management

| Event ID | Description | Severity | Detection Use Case |
|----------|-------------|----------|-------------------|
| 4720 | User account created | High | Account creation |
| 4722 | User account enabled | Medium | Account changes |
| 4724 | Password reset attempt | High | Credential changes |
| 4728 | Member added to security group | Critical | Privilege changes |
| 4732 | Member added to local group | High | Local admin changes |
| 4756 | Member added to universal group | Critical | Enterprise admin changes |

---

## Detection Rules (SIGMA Format)

### Credential Dumping Detection

```yaml
title: LSASS Memory Access for Credential Dumping
id: 0d894093-71bc-43c3-8c4d-ecfc28dcf5d9
status: stable
description: Detects process accessing LSASS memory which is typical for credential dumping
references:
    - https://attack.mitre.org/techniques/T1003/001/
author: Security Team
date: 2024/01/15
logsource:
    category: process_access
    product: windows
detection:
    selection:
        TargetImage|endswith: '\lsass.exe'
        GrantedAccess|contains:
            - '0x1010'
            - '0x1410'
            - '0x147a'
            - '0x143a'
            - '0x1fffff'
    filter_known:
        SourceImage|endswith:
            - '\wmiprvse.exe'
            - '\svchost.exe'
            - '\MsMpEng.exe'
            - '\csrss.exe'
    condition: selection and not filter_known
falsepositives:
    - Legitimate security tools
    - Windows Defender
level: critical
tags:
    - attack.credential_access
    - attack.t1003.001
```

### Lateral Movement Detection

```yaml
title: PsExec Service Installation
id: 730fc21b-eaff-474b-ad23-e17a60e97c85
status: stable
description: Detects PsExec service installation for lateral movement
references:
    - https://attack.mitre.org/techniques/T1021/002/
author: Security Team
date: 2024/01/15
logsource:
    product: windows
    service: system
detection:
    selection:
        EventID: 7045
        ServiceName|contains:
            - 'PSEXESVC'
            - 'PSEXEC'
            - 'csexec'
    condition: selection
falsepositives:
    - Legitimate administrative activity
level: high
tags:
    - attack.lateral_movement
    - attack.t1021.002
```

### Ransomware Behavior Detection

```yaml
title: Mass File Encryption Activity
id: 6b2d7259-2415-47c1-a65c-f145d85c64ff
status: experimental
description: Detects mass file modification typical of ransomware
author: Security Team
date: 2024/01/15
logsource:
    product: windows
    service: security
detection:
    selection:
        EventID: 4663
        ObjectType: File
        AccessMask:
            - '0x2'      # WRITE_DATA
            - '0x6'      # WRITE_DATA | APPEND_DATA
    timeframe: 1m
    condition: selection | count() by SubjectUserName > 100
falsepositives:
    - Backup software
    - Compression utilities
    - Large file transfers
level: critical
tags:
    - attack.impact
    - attack.t1486
```

---

## Correlation Rules

### Brute Force Detection

```
RULE: Brute Force Attack Detection
─────────────────────────────────────────────────────────────────────────────

TRIGGER: 5+ failed logins from same source IP within 5 minutes

QUERY (Splunk SPL):
index=windows EventCode=4625
| bin _time span=5m
| stats count by src_ip, user
| where count >= 5

QUERY (Elastic KQL):
event.code: 4625
| stats count(*) as failed_attempts by source.ip, user.name
| where failed_attempts >= 5

RESPONSE:
1. Alert SOC Tier 1
2. Enrich with GeoIP
3. Check if source IP is known
4. If external: Block at firewall
5. If internal: Investigate workstation
```

### Lateral Movement Chain

```
RULE: Lateral Movement Chain Detection
─────────────────────────────────────────────────────────────────────────────

TRIGGER: Same credentials used across 3+ hosts within 1 hour

CHAIN DETECTION:
1. Successful auth on Host A (Event 4624)
2. Followed by auth attempt on Host B (Event 4624/4625)
3. Followed by auth attempt on Host C (Event 4624/4625)
4. Using same credentials

QUERY (Splunk SPL):
index=windows EventCode IN (4624, 4625) Logon_Type IN (3, 10)
| transaction user maxspan=1h maxpause=15m
| where mvcount(dest) >= 3
| table _time, user, dest, src_ip, EventCode

RESPONSE:
1. Alert SOC Tier 2 (High Severity)
2. Correlate with EDR for process context
3. Check for known attack tools
4. Isolate source workstation
5. Reset compromised credentials
```

### Data Exfiltration Detection

```
RULE: Anomalous Data Transfer
─────────────────────────────────────────────────────────────────────────────

TRIGGER: Unusual outbound data volume to external destination

BASELINE: User's average outbound traffic over 30 days

DETECTION:
- Current transfer > 3 standard deviations from baseline
- OR > 1GB to new external destination
- OR transfer to known file sharing services

QUERY (Elastic):
{
  "query": {
    "bool": {
      "must": [
        { "range": { "destination.bytes": { "gte": 1073741824 } } },
        { "term": { "network.direction": "outbound" } }
      ],
      "must_not": [
        { "terms": { "destination.ip": ["known_cdn_ips"] } }
      ]
    }
  },
  "aggs": {
    "by_user": {
      "terms": { "field": "user.name" },
      "aggs": {
        "total_bytes": { "sum": { "field": "destination.bytes" } }
      }
    }
  }
}

RESPONSE:
1. Alert SOC Tier 2
2. Identify destination (IP, domain reputation)
3. Review user's recent activity
4. Check DLP alerts
5. Interview user if necessary
```

---

## SIEM Dashboard Examples

### SOC Overview Dashboard

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ SECURITY OPERATIONS CENTER - OVERVIEW                      [LIVE] 15:32:45  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ALERTS TODAY               MEAN TIME TO RESPOND          EVENTS/SEC        │
│  ┌─────────────────┐        ┌─────────────────┐          ┌─────────────┐   │
│  │    ████ 127     │        │    23 min       │          │   12,456    │   │
│  │  Critical: 3    │        │  Target: 30 min │          │   ▲ 12%     │   │
│  │  High: 24       │        │  Status: ✓      │          │             │   │
│  │  Medium: 67     │        │                 │          │             │   │
│  │  Low: 33        │        │                 │          │             │   │
│  └─────────────────┘        └─────────────────┘          └─────────────┘   │
│                                                                             │
│  ALERT TREND (24h)                                                          │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │     ▲                                                                │   │
│  │ 150─┤        ██                                                      │   │
│  │     │     ██ ██ ██                                                   │   │
│  │ 100─┤  ██ ██ ██ ██ ██                                    ██          │   │
│  │     │  ██ ██ ██ ██ ██ ██             ██ ██          ██ ██ ██         │   │
│  │  50─┤  ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██     │   │
│  │     │  ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██ ██  │   │
│  │   0─┼──────────────────────────────────────────────────────────────  │   │
│  │     00  02  04  06  08  10  12  14  16  18  20  22  Now              │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
│  TOP ALERT TYPES                    TOP SOURCE IPs (SUSPICIOUS)             │
│  ┌─────────────────────────────┐   ┌─────────────────────────────────────┐ │
│  │ 1. Failed Logins      34    │   │ 192.168.1.45   - 45 alerts (INT)    │ │
│  │ 2. Malware Detected   23    │   │ 203.0.113.55   - 32 alerts (CN)     │ │
│  │ 3. Policy Violation   19    │   │ 10.0.50.102    - 28 alerts (INT)    │ │
│  │ 4. Port Scan          15    │   │ 198.51.100.23  - 21 alerts (RU)     │ │
│  │ 5. Suspicious Process 12    │   │ 172.16.0.88    - 18 alerts (INT)    │ │
│  └─────────────────────────────┘   └─────────────────────────────────────┘ │
│                                                                             │
│  ACTIVE INCIDENTS                                                           │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │ INC-2024-0156 │ CRITICAL │ Ransomware │ Containment │ @analyst1     │   │
│  │ INC-2024-0155 │ HIGH     │ Phishing   │ Analysis    │ @analyst2     │   │
│  │ INC-2024-0154 │ MEDIUM   │ Malware    │ Eradication │ @analyst1     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## Log Pipeline Architecture

### Logstash Configuration

```ruby
# /etc/logstash/conf.d/siem-pipeline.conf

input {
  # Windows Events via Winlogbeat
  beats {
    port => 5044
    type => "windows"
  }

  # Syslog from network devices
  syslog {
    port => 514
    type => "syslog"
  }

  # Filebeat for application logs
  beats {
    port => 5045
    type => "application"
  }

  # Kafka for high-volume sources
  kafka {
    bootstrap_servers => "kafka1:9092,kafka2:9092"
    topics => ["firewall-logs", "dns-logs"]
    group_id => "siem-logstash"
    codec => json
  }
}

filter {
  # Parse Windows events
  if [type] == "windows" {
    mutate {
      add_field => { "log_source" => "windows" }
    }

    # Enrich with GeoIP
    if [source][ip] {
      geoip {
        source => "[source][ip]"
        target => "[source][geo]"
      }
    }

    # Enrich with threat intelligence
    translate {
      field => "[source][ip]"
      destination => "[threat][indicator]"
      dictionary_path => "/etc/logstash/threat-intel.yml"
      fallback => "unknown"
    }

    # Add asset context
    translate {
      field => "[host][hostname]"
      destination => "[asset][criticality]"
      dictionary_path => "/etc/logstash/asset-criticality.yml"
      fallback => "medium"
    }
  }

  # Parse Syslog
  if [type] == "syslog" {
    grok {
      match => { "message" => "%{SYSLOGTIMESTAMP:syslog_timestamp} %{SYSLOGHOST:syslog_hostname} %{DATA:syslog_program}(?:\[%{POSINT:syslog_pid}\])?: %{GREEDYDATA:syslog_message}" }
    }
  }

  # Normalize fields to ECS
  mutate {
    rename => {
      "src_ip" => "[source][ip]"
      "dst_ip" => "[destination][ip]"
      "src_port" => "[source][port]"
      "dst_port" => "[destination][port]"
    }
  }
}

output {
  # Send to Elasticsearch
  elasticsearch {
    hosts => ["es1:9200", "es2:9200", "es3:9200"]
    index => "siem-%{[log_source]}-%{+YYYY.MM.dd}"
    user => "logstash"
    password => "${ES_PASSWORD}"
    ssl => true
    cacert => "/etc/logstash/certs/ca.crt"
  }

  # Send critical alerts to SOAR
  if [event][severity] == "critical" {
    http {
      url => "https://soar.company.com/api/alerts"
      http_method => "post"
      format => "json"
      headers => {
        "Authorization" => "Bearer ${SOAR_TOKEN}"
      }
    }
  }
}
```

---

## Capacity Planning

### Sizing Calculator

| Component | Formula | Example (10K endpoints) |
|-----------|---------|-------------------------|
| Storage (daily) | EPS × 86400 × avg_event_size | 5000 × 86400 × 500B = 216 GB |
| Storage (90 days) | Daily × 90 × 1.3 (index overhead) | 216 × 90 × 1.3 = 25 TB |
| Elasticsearch Nodes | Storage / 30TB per node | 25 / 30 = 1 (min 3 for HA) |
| Logstash Workers | EPS / 5000 per core | 5000 / 5000 = 1 core (4 min) |
| Kafka Partitions | EPS / 10000 per partition | 5000 / 10000 = 1 (3 for HA) |

### Recommended Architecture by Size

| Size | Endpoints | EPS | Elasticsearch | Kafka | Logstash |
|------|-----------|-----|---------------|-------|----------|
| Small | < 1,000 | < 1,000 | 3 × 16GB/500GB | N/A | 2 × 4 core |
| Medium | 1,000-10,000 | 1,000-10,000 | 6 × 32GB/2TB | 3 brokers | 4 × 8 core |
| Large | 10,000-50,000 | 10,000-50,000 | 12 × 64GB/4TB | 5 brokers | 8 × 16 core |
| Enterprise | 50,000+ | 50,000+ | 24+ × 128GB/8TB | 7+ brokers | 16+ × 32 core |

---

## Operational Procedures

### Daily SOC Checklist

```
┌─────────────────────────────────────────────────────────────────────────────┐
│ DAILY SOC OPERATIONS CHECKLIST                                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  SHIFT START                                                                │
│  □ Review shift handoff notes                                               │
│  □ Check SIEM health dashboard                                              │
│  □ Verify all log sources are active                                        │
│  □ Review overnight critical/high alerts                                    │
│  □ Check threat intelligence updates                                        │
│                                                                             │
│  CONTINUOUS MONITORING                                                      │
│  □ Triage new alerts within 15 minutes                                      │
│  □ Escalate critical alerts immediately                                     │
│  □ Document all investigations                                              │
│  □ Update alert status in tracking system                                   │
│                                                                             │
│  THREAT HUNTING (1 hour daily)                                              │
│  □ Execute scheduled hunt queries                                           │
│  □ Review new IOCs and search historical logs                               │
│  □ Investigate anomalies flagged by ML                                      │
│  □ Document findings and create detections                                  │
│                                                                             │
│  SHIFT END                                                                  │
│  □ Update shift handoff notes                                               │
│  □ Ensure no critical alerts unassigned                                     │
│  □ Report metrics to SOC Manager                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## References

- [Elastic SIEM](https://www.elastic.co/security)
- [Splunk Security](https://www.splunk.com/en_us/software/enterprise-security.html)
- [SIGMA Rules](https://github.com/SigmaHQ/sigma)
- [MITRE ATT&CK](https://attack.mitre.org/)
