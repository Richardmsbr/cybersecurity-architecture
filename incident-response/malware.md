# Malware Incident Response Playbook

This playbook provides structured procedures for detecting, containing, eradicating, and recovering from malware infections across enterprise environments.

---

## Malware Classification

| Type | Description | Severity | Example |
|------|-------------|----------|---------|
| Ransomware | Encrypts files, demands payment | Critical | LockBit, BlackCat |
| RAT | Remote access trojan | Critical | Cobalt Strike, Emotet |
| Worm | Self-propagating malware | High | WannaCry, Conficker |
| Trojan | Disguised malicious software | High | TrickBot, Qakbot |
| Rootkit | Hides presence, maintains access | High | TDL, ZeroAccess |
| Cryptominer | Uses resources for mining | Medium | XMRig |
| Adware | Unwanted advertising | Low | Various |
| PUP | Potentially unwanted program | Low | Various |

---

## Detection Phase

### Detection Sources

```
    MALWARE DETECTION SOURCES

    Endpoint:
    +------------------+
    | EDR/AV Alerts    |---> Signature match, behavior detection
    | Process Monitor  |---> Suspicious processes
    | File Integrity   |---> Unexpected changes
    | Memory Analysis  |---> Injected code
    +------------------+

    Network:
    +------------------+
    | IDS/IPS          |---> Network signatures
    | DNS Monitoring   |---> C2 communication
    | Proxy Logs       |---> Malicious URLs
    | NetFlow          |---> Anomalous traffic
    +------------------+

    SIEM:
    +------------------+
    | Correlation      |---> Multi-source detection
    | Threat Intel     |---> IOC matching
    | UEBA             |---> Behavioral anomalies
    +------------------+
```

### Initial Indicators

| Indicator Type | Examples |
|----------------|----------|
| File Hash | MD5, SHA1, SHA256 of malicious files |
| File Name | Known malware file names |
| File Path | Suspicious locations (%TEMP%, AppData) |
| Process | Unusual parent-child relationships |
| Network | C2 IPs, domains, user-agents |
| Registry | Persistence keys, run entries |
| Behavior | Encryption activity, lateral movement |

### Triage Questions

| Question | Investigation Method |
|----------|---------------------|
| What malware family? | Hash lookup, sandbox analysis |
| How was it delivered? | Email logs, web proxy, USB |
| Is it active? | Process analysis, network connections |
| Has it spread? | Network scans, endpoint queries |
| What is the impact? | Data access, system changes |

---

## Containment Phase

### Immediate Containment Actions

| Action | When to Use | Risk |
|--------|-------------|------|
| Network isolation | Active C2, lateral movement | Service disruption |
| Disable user account | Compromised credentials | User impact |
| Block IOCs at perimeter | Known malicious indicators | False positives |
| Quarantine endpoint | Confirmed infection | Productivity loss |
| Kill malicious process | Active execution | Evidence loss |

### Containment Decision Tree

```
    CONTAINMENT DECISION

    Is malware actively
    communicating with C2?
           |
    +------+------+
    | Yes         | No
    v             v
    Isolate       Is malware
    immediately   spreading?
                  |
           +------+------+
           | Yes         | No
           v             v
           Isolate       Monitor and
           segment       collect evidence
```

### Network Containment

| Layer | Action |
|-------|--------|
| Firewall | Block C2 IPs/domains |
| Proxy | Block malicious URLs |
| DNS | Sinkhole malicious domains |
| Switch | VLAN isolation |
| NAC | Quarantine endpoint |

### Endpoint Containment

| Action | Implementation |
|--------|---------------|
| Network isolation | Disable NIC, VLAN change |
| Process termination | Kill malicious processes |
| Service disable | Stop malicious services |
| Account disable | Disable compromised accounts |
| Boot restriction | Prevent reboot (preserve memory) |

---

## Analysis Phase

### Static Analysis

| Technique | Tool | Purpose |
|-----------|------|---------|
| Hash lookup | VirusTotal, Malware Bazaar | Known malware identification |
| String extraction | strings, FLOSS | Embedded indicators |
| PE analysis | PE-bear, pestudio | File structure analysis |
| Packer detection | Detect It Easy | Obfuscation identification |

### Dynamic Analysis

| Technique | Tool | Purpose |
|-----------|------|---------|
| Sandbox execution | Any.run, Joe Sandbox | Behavior analysis |
| Process monitoring | Process Monitor | System changes |
| Network capture | Wireshark, Fiddler | C2 communication |
| Registry monitoring | Regshot | Persistence mechanisms |

### Memory Analysis

```
    MEMORY FORENSICS WORKFLOW

    1. Memory Acquisition
       - WinPMEM, FTK Imager
       - Live memory capture

    2. Process Analysis
       - List processes
       - Identify injection
       - Hidden processes

    3. Network Connections
       - Active connections
       - Listening ports
       - C2 indicators

    4. Code Injection
       - Hollowed processes
       - Injected DLLs
       - Shellcode

    5. Persistence
       - Registry keys
       - Scheduled tasks
       - Services
```

### Malware Behavior Analysis

| Behavior | Detection Method | Significance |
|----------|------------------|--------------|
| File encryption | File system monitoring | Ransomware |
| Credential theft | LSASS access monitoring | Data theft |
| Lateral movement | Network connection analysis | Spread |
| Persistence | Registry/scheduled task monitoring | Long-term access |
| Data exfiltration | Network traffic analysis | Data breach |
| C2 communication | DNS/HTTP analysis | Remote control |

---

## Eradication Phase

### Malware Removal

| Step | Action | Verification |
|------|--------|--------------|
| 1 | Terminate malicious processes | Process list clean |
| 2 | Remove malicious files | File system scan |
| 3 | Clean registry entries | Registry scan |
| 4 | Remove scheduled tasks | Task scheduler review |
| 5 | Remove malicious services | Services review |
| 6 | Scan for additional malware | Full AV/EDR scan |

### Persistence Mechanism Removal

| Mechanism | Location | Removal |
|-----------|----------|---------|
| Run keys | HKLM/HKCU\...\Run | Delete entry |
| Scheduled tasks | Task Scheduler | Delete task |
| Services | Services.msc | Delete service |
| WMI subscriptions | WMI repository | Remove subscription |
| Startup folder | Shell:startup | Delete file |
| DLL hijacking | Various | Replace DLL |
| Boot record | MBR/VBR | Rebuild boot record |

### System Hardening

| Action | Implementation |
|--------|---------------|
| Patch vulnerabilities | Deploy security updates |
| Update signatures | Update AV/EDR definitions |
| Credential rotation | Reset affected passwords |
| Review permissions | Remove excessive access |
| Enable additional logging | Expand monitoring coverage |

---

## Recovery Phase

### System Restoration Options

| Option | When to Use | Risk |
|--------|-------------|------|
| Clean and restore | Minor infection | Data loss if incomplete |
| Reimage | Extensive infection | Service downtime |
| Restore from backup | System unrecoverable | Backup integrity |

### Recovery Validation

```
    RECOVERY VALIDATION CHECKLIST

    [ ] System boots normally
    [ ] All services operational
    [ ] No malware detected (multiple AV)
    [ ] No suspicious network connections
    [ ] No suspicious processes
    [ ] File integrity verified
    [ ] Patch level current
    [ ] Credentials rotated
    [ ] Enhanced monitoring enabled
```

### Staged Recovery

| Phase | Action | Duration |
|-------|--------|----------|
| 1 | Restore to isolated network | Day 1 |
| 2 | Validate clean state | Day 1-2 |
| 3 | Limited network connectivity | Day 2-3 |
| 4 | Full network restoration | Day 3+ |
| 5 | Enhanced monitoring period | 30 days |

---

## IOC Management

### IOC Collection

| IOC Type | Source | Format |
|----------|--------|--------|
| File hashes | Malware samples | MD5, SHA256 |
| IP addresses | Network logs | IPv4/IPv6 |
| Domains | DNS logs, malware config | FQDN |
| URLs | Proxy logs, malware analysis | Full URL |
| Email indicators | Email headers | Sender, subject |
| Registry keys | Endpoint analysis | Full path |
| File paths | Endpoint analysis | Full path |

### IOC Distribution

| Destination | Format | Purpose |
|-------------|--------|---------|
| SIEM | Custom format | Detection rules |
| EDR | Platform-specific | Endpoint detection |
| Firewall | IP/domain lists | Blocking |
| Proxy | URL lists | Web filtering |
| Email gateway | Sender/subject | Email filtering |
| Threat intel platform | STIX/TAXII | Sharing |

---

## Scope Assessment

### Spread Analysis

| Method | Tool | Purpose |
|--------|------|---------|
| IOC sweep | EDR, SIEM | Find additional infections |
| Network analysis | Flow data, logs | Identify lateral movement |
| Active Directory review | AD logs | Credential compromise |
| Email analysis | Email gateway | Distribution vector |

### Impact Assessment

| Category | Assessment Questions |
|----------|---------------------|
| Systems | How many systems affected? |
| Data | Was data accessed or exfiltrated? |
| Credentials | Were credentials compromised? |
| Operations | What is business impact? |
| Compliance | Are there regulatory implications? |

---

## Communication

### Internal Notification

| Stakeholder | Information | Timing |
|-------------|-------------|--------|
| IT Security | Full technical details | Immediate |
| IT Operations | Operational impact | Immediate |
| Management | Business impact summary | Within hours |
| Legal | Potential breach implications | As needed |
| HR | If employee-related | As needed |

### External Notification

| Party | Circumstance | Information |
|-------|--------------|-------------|
| Law enforcement | Significant attack | Incident details |
| Regulators | If data breach | Per requirements |
| Partners | If they are affected | Relevant details |
| Insurance | If claim warranted | Incident documentation |

---

## Lessons Learned

### Post-Incident Review

| Topic | Questions |
|-------|-----------|
| Detection | How was malware detected? What was dwell time? |
| Prevention | Why did preventive controls fail? |
| Response | Was response timely and effective? |
| Communication | Was communication adequate? |
| Tools | Did tools perform as expected? |

### Improvement Actions

| Category | Potential Improvements |
|----------|----------------------|
| Prevention | Email filtering, web filtering, application control |
| Detection | EDR tuning, network monitoring, threat intel |
| Response | Playbook updates, tool improvements, training |
| Recovery | Backup validation, system imaging, automation |

---

## References

- NIST SP 800-83 Guide to Malware Incident Prevention and Handling
- SANS Malware Analysis Fundamentals
- MITRE ATT&CK Framework

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2024-01-15 | Security Architecture | Initial release |
